"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2538],{3905:(n,e,t)=>{t.d(e,{Zo:()=>l,kt:()=>d});var r=t(7294);function i(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function o(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function h(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?o(Object(t),!0).forEach((function(e){i(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function a(n,e){if(null==n)return{};var t,r,i=function(n,e){if(null==n)return{};var t,r,i={},o=Object.keys(n);for(r=0;r<o.length;r++)t=o[r],e.indexOf(t)>=0||(i[t]=n[t]);return i}(n,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);for(r=0;r<o.length;r++)t=o[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(i[t]=n[t])}return i}var c=r.createContext({}),s=function(n){var e=r.useContext(c),t=e;return n&&(t="function"==typeof n?n(e):h(h({},e),n)),t},l=function(n){var e=s(n.components);return r.createElement(c.Provider,{value:e},n.children)},g="mdxType",u={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},p=r.forwardRef((function(n,e){var t=n.components,i=n.mdxType,o=n.originalType,c=n.parentName,l=a(n,["components","mdxType","originalType","parentName"]),g=s(t),p=i,d=g["".concat(c,".").concat(p)]||g[p]||u[p]||o;return t?r.createElement(d,h(h({ref:e},l),{},{components:t})):r.createElement(d,h({ref:e},l))}));function d(n,e){var t=arguments,i=e&&e.mdxType;if("string"==typeof n||i){var o=t.length,h=new Array(o);h[0]=p;var a={};for(var c in e)hasOwnProperty.call(e,c)&&(a[c]=e[c]);a.originalType=n,a[g]="string"==typeof n?n:i,h[1]=a;for(var s=2;s<o;s++)h[s]=t[s];return r.createElement.apply(null,h)}return r.createElement.apply(null,t)}p.displayName="MDXCreateElement"},5095:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>h,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>s});var r=t(7462),i=(t(7294),t(3905));const o={title:"Process v\xe0 Thread trong Node.js"},h=void 0,a={unversionedId:"blog/process-nodejs",id:"blog/process-nodejs",title:"Process v\xe0 Thread trong Node.js",description:"Sau khi tr\u1ea3i qua n l\u1ea7n ph\u1ecfng v\u1ea5n cho v\u1ecb tr\xed Node.js Developer, t\xf4i \u0111\xe3 g\u1eb7p nhi\u1ec1u c\xe2u h\u1ecfi xoay quanh c\xe1c v\u1ea5n \u0111\u1ec1 nh\u01b0 Event Loop, Scope, Non Blocking I/O, Asynchronous,... \u0110\xe2y l\xe0 nh\u1eefng c\xe2u h\u1ecfi ph\u1ed5 bi\u1ebfn khi ph\u1ecfng v\u1ea5n cho v\u1ecb tr\xed Node.js Developer. Tuy nhi\xean, ngo\xe0i nh\u1eefng c\xe2u h\u1ecfi \u0111\xf3, c\xf2n c\xf3 m\u1ed9t s\u1ed1 c\xe2u h\u1ecfi khi\u1ebfn t\xf4i t\xf2 m\xf2 v\u1ec1 c\xe1ch qu\u1ea3n l\xfd v\xe0 m\u1edf r\u1ed9ng thread, process trong Node.js. T\xf4i t\u1eebng nghe v\xe0 t\xecm hi\u1ec3u v\u1ec1 c\xe1c kh\xe1i ni\u1ec7m Cluster, Child Process v\xe0 Worker Threads trong c\xe1c b\xe0i blog, nh\u01b0ng th\u1ef1c t\u1ebf th\xec t\xf4i \xedt khi \u0111\u01b0\u1ee3c \xe1p d\u1ee5ng v\xe0 hi\u1ec3u v\u1ec1 c\u01a1 ch\u1ebf \u0111\u1eb7c bi\u1ec7t n\xe0y c\u1ee7a Node.js. \ud83d\ude02",source:"@site/docs/blog/1-process-nodejs.md",sourceDirName:"blog",slug:"/blog/process-nodejs",permalink:"/docs/blog/process-nodejs",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Process v\xe0 Thread trong Node.js"},sidebar:"blogs"},c={},s=[{value:"Kh\xe1i ni\u1ec7m v\u1ec1 Process v\xe0 Thread",id:"kh\xe1i-ni\u1ec7m-v\u1ec1-process-v\xe0-thread",level:2},{value:"Process",id:"process",level:3},{value:"Thread",id:"thread",level:3},{value:"Worker Threads l\xe0 g\xec",id:"worker-threads-l\xe0-g\xec",level:2},{value:"Child Process",id:"child-process",level:2},{value:"Cluster trong Node.js",id:"cluster-trong-nodejs",level:2},{value:"T\xf3m t\u1eaft",id:"t\xf3m-t\u1eaft",level:2},{value:"Ngu\u1ed3n",id:"ngu\u1ed3n",level:2}],l={toc:s},g="wrapper";function u(n){let{components:e,...t}=n;return(0,i.kt)(g,(0,r.Z)({},l,t,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Sau khi tr\u1ea3i qua n l\u1ea7n ph\u1ecfng v\u1ea5n cho v\u1ecb tr\xed Node.js Developer, t\xf4i \u0111\xe3 g\u1eb7p nhi\u1ec1u c\xe2u h\u1ecfi xoay quanh c\xe1c v\u1ea5n \u0111\u1ec1 nh\u01b0 Event Loop, Scope, Non Blocking I/O, Asynchronous,... \u0110\xe2y l\xe0 nh\u1eefng c\xe2u h\u1ecfi ph\u1ed5 bi\u1ebfn khi ph\u1ecfng v\u1ea5n cho v\u1ecb tr\xed Node.js Developer. Tuy nhi\xean, ngo\xe0i nh\u1eefng c\xe2u h\u1ecfi \u0111\xf3, c\xf2n c\xf3 m\u1ed9t s\u1ed1 c\xe2u h\u1ecfi khi\u1ebfn t\xf4i t\xf2 m\xf2 v\u1ec1 c\xe1ch qu\u1ea3n l\xfd v\xe0 m\u1edf r\u1ed9ng ",(0,i.kt)("strong",{parentName:"p"},"thread"),", ",(0,i.kt)("strong",{parentName:"p"},"process")," trong Node.js. T\xf4i t\u1eebng nghe v\xe0 t\xecm hi\u1ec3u v\u1ec1 c\xe1c kh\xe1i ni\u1ec7m ",(0,i.kt)("strong",{parentName:"p"},"Cluster"),", ",(0,i.kt)("strong",{parentName:"p"},"Child Process")," v\xe0 ",(0,i.kt)("strong",{parentName:"p"},"Worker Threads")," trong c\xe1c b\xe0i blog, nh\u01b0ng th\u1ef1c t\u1ebf th\xec t\xf4i \xedt khi \u0111\u01b0\u1ee3c \xe1p d\u1ee5ng v\xe0 hi\u1ec3u v\u1ec1 c\u01a1 ch\u1ebf \u0111\u1eb7c bi\u1ec7t n\xe0y c\u1ee7a Node.js. \ud83d\ude02"),(0,i.kt)("p",null,"Tuy nhi\xean, \u0111\u1ec3 hi\u1ec3u r\xf5 s\u1ee9c m\u1ea1nh c\u1ee7a Node.js trong vi\u1ec7c n\xe0y, ch\xfang ta c\u1ea7n b\u1eaft \u0111\u1ea7u t\u1eeb nh\u1eefng kh\xe1i ni\u1ec7m c\u0103n b\u1ea3n: ",(0,i.kt)("strong",{parentName:"p"},"Process")," v\xe0 ",(0,i.kt)("strong",{parentName:"p"},"Thread")," trong l\u1eadp tr\xecnh. C\u1ea3 hai \u0111\u1ec1u l\xe0 n\u1ec1n t\u1ea3ng c\u01a1 b\u1ea3n cho b\u1ea5t k\u1ef3 h\u1ec7 th\u1ed1ng x\u1eed l\xfd \u0111a t\xe1c v\u1ee5 n\xe0o, v\xe0 hi\u1ec3u bi\u1ebft v\u1eefng ch\u1eafc v\u1ec1 ch\xfang s\u1ebd gi\xfap ta kh\xe1m ph\xe1 s\xe2u h\u01a1n v\u1ec1 c\xe1ch Node.js s\u1eed d\u1ee5ng ch\xfang \u0111\u1ec3 t\u1ed1i \u01b0u hi\u1ec7u su\u1ea5t v\xe0 kh\xf4ng ch\u1ec9 gi\u1edbi h\u1ea1n \u1edf Node.js c\xf2n nhi\u1ec1u ng\xf4n ng\u1eef l\u1eadp tr\xecnh kh\xe1c c\u0169ng xoay quanh v\u1ec1 n\xe0y."),(0,i.kt)("h2",{id:"kh\xe1i-ni\u1ec7m-v\u1ec1-process-v\xe0-thread"},"Kh\xe1i ni\u1ec7m v\u1ec1 Process v\xe0 Thread"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/quankori/quankori.github.io/master/src/images/programming/8.PNG",alt:"Image"})),(0,i.kt)("h3",{id:"process"},"Process"),(0,i.kt)("p",null,"Nh\u01b0 tr\xean h\xecnh, Process bao g\u1ed3m c\xe1c ph\u1ea7n Thread v\xe0 Memory. Process \u0111\u1ea1i di\u1ec7n cho 1 ti\u1ebfn tr\xecnh di\u1ec5n ra, ti\u1ebfn tr\xecnh \u1edf \u0111\xe2y c\xf3 th\u1ec3 h\xecnh dung khi b\u1ea1n m\u1edf 1 tr\xecnh duy\u1ec7t ho\u1eb7c ch\u1ea1y m\u1ed9t ch\u01b0\u01a1ng tr\xecnh th\xec l\xfac n\xe0y t\u1ea1o ra m\u1ed9t ti\u1ebfn tr\xecnh."),(0,i.kt)("p",null,"C\xe1c th\xe0nh ph\u1ea7n c\u1ee7a 1 ti\u1ebfn tr\xecnh (Process) khi ch\u1ea1y \u0111\u01b0\u1ee3c h\u1ec7 \u0111i\u1ec1u h\xe0nh c\u1ea5p:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"M\xe3 \u0111\u1ecbnh danh ti\u1ebfn tr\xecnh g\u1ecdi l\xe0 PID."),(0,i.kt)("li",{parentName:"ul"},"\xcdt nh\u1ea5t m\u1ed9t main thread cho process, main thread t\u1eaft th\xec process c\u0169ng t\u1eaft theo."),(0,i.kt)("li",{parentName:"ul"},"V\xf9ng nh\u1edb cho Process, nh\u01b0 trong h\xecnh l\xe0 ph\u1ea7n m\xe0u tr\u1eafng. V\u1edbi b\u1ed9 nh\u1edb chung l\xe0 Heap (ph\u1ea7n m\xe0u xanh d\u01b0\u01a1ng)")),(0,i.kt)("h3",{id:"thread"},"Thread"),(0,i.kt)("p",null,"Thread l\xe0 m\u1ed9t lu\u1ed3ng trong ti\u1ebfn tr\xecnh, nh\u01b0 trong h\xecnh th\xec trong c\xe1c thread s\u1ebd c\xf3 hai th\xe0nh ph\u1ea7n ch\xednh l\xe0:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Registers")," c\xf3 th\u1ec3 hi\u1ec3u l\xe0 n\u01a1i l\u01b0u tr\u1eef bi\u1ebfn t\u1ea1m th\u1eddi khi th\u1ef1c thi thread"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Stack")," l\xe0 v\xf9ng nh\u1edb trong thread \u0111\u01b0\u1ee3c c\u1ea5p kho\u1ea3ng 1-2 MB")),(0,i.kt)("p",null,"V\xe0 ngo\xe0i ra c\xe1c thread s\u1ebd x\xe0i chung v\xf9ng b\u1ed9 nh\u1edb chung l\xe0 Heap (v\xf9ng xanh d\u01b0\u01a1ng). Tuy nhi\xean, khi qu\u1ea3n l\xfd multi thread ch\xfang ta s\u1ebd g\u1eb7p m\u1ed9t s\u1ed1 thu\u1eadt v\u1ea5n \u0111\u1ec1 sau:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Khi process t\u1ea1o qu\xe1 nhi\u1ec1u thread s\u1ebd b\u1ecb l\u1ed7i ",(0,i.kt)("strong",{parentName:"li"},"stack overflow")),(0,i.kt)("li",{parentName:"ul"},"Khi thread s\u1eed d\u1ee5ng chung b\u1ed9 nh\u1edb Heap b\u1ecb xung \u0111\u1ed9t d\u1eef li\u1ec7u s\u1ebd x\u1ea3y ra l\u1ed7i ",(0,i.kt)("strong",{parentName:"li"},"race condition")),(0,i.kt)("li",{parentName:"ul"},"S\u1ed1 l\u01b0\u1ee3ng thread ch\u1ea1y song song m\u1ed9t th\u1eddi \u0111i\u1ec3m s\u1ebd b\u1eb1ng s\u1ed1 l\u01b0\u1ee3ng CPU m\xe0 ch\xfang ta \u0111ang c\xf3 => nhi\u1ec1u thread kh\xf4ng gi\xfap nhanh h\u01a1n. Th\u01b0\u1eddng s\u1ebd l\xe0 s\u1ed1 thread ch\u1ea1y song song = s\u1ed1 core CPU ","*"," 2 \ud83e\uddd0")),(0,i.kt)("h2",{id:"worker-threads-l\xe0-g\xec"},"Worker Threads l\xe0 g\xec"),(0,i.kt)("p",null,"Trong m\u1ed9t s\u1ed1 kh\xe1i ni\u1ec7m c\u1ed1t l\xf5i c\u1ee7a Node.js, m\u1ed9t th\u1eddi gian d\xe0i n\xf3 \u0111\u01b0\u1ee3c xem l\xe0 m\u1ed9t m\xf4i tr\u01b0\u1eddng \u0111\u01a1n lu\u1ed3ng (single thread). Tuy nhi\xean, t\u1eeb phi\xean b\u1ea3n 10.5 tr\u1edf \u0111i, Node.js \u0111\xe3 gi\u1edbi thi\u1ec7u t\xednh n\u0103ng ",(0,i.kt)("inlineCode",{parentName:"p"},"worker_thread")," v\xe0 t\u1eeb phi\xean b\u1ea3n 12, t\xednh n\u0103ng n\xe0y \u0111\xe3 tr\u1edf th\xe0nh \u1ed5n \u0111\u1ecbnh. \u0110i\u1ec1u n\xe0y \u0111\xe3 m\u1edf ra c\xe1nh c\u1eeda cho m\u1ed9t s\u1ef1 c\u1ea3i ti\u1ebfn m\u1edbi v\u1ec1 vi\u1ec7c s\u1eed d\u1ee5ng \u0111a lu\u1ed3ng (multi-thread) trong Node.js."),(0,i.kt)("p",null,"Nh\u01b0ng t\u1ea1i sao l\u1ea1i c\u1ea7n t\xednh n\u0103ng \u0111a lu\u1ed3ng (worker_thread) khi Node.js \u0111ang c\xf3 \u01b0u \u0111i\u1ec3m l\xe0 \u0111\u01a1n lu\u1ed3ng?"),(0,i.kt)("p",null,"Tr\u01b0\u1edbc khi n\xf3i v\u1ec1 l\u1ee3i \xedch c\u1ee7a worker_thread, ch\xfang ta h\xe3y xem x\xe9t c\xe1c h\u1ea1n ch\u1ebf v\xe0 \u0111i\u1ec3m y\u1ebfu c\u1ee7a vi\u1ec7c s\u1eed d\u1ee5ng \u0111\u01a1n lu\u1ed3ng. D\xf9 th\u1ef1c hi\u1ec7n c\xe1c t\xe1c v\u1ee5 kh\xf4ng \u0111\u1ed3ng b\u1ed9 (non-blocking) gi\xfap \u0111\u1ecbnh h\xecnh s\u1ee9c m\u1ea1nh c\u1ee7a \u0111\u01a1n lu\u1ed3ng, nh\u01b0ng n\xf3 v\u1eabn b\u1ecb gi\u1edbi h\u1ea1n trong vi\u1ec7c x\u1eed l\xfd c\xe1c t\xe1c v\u1ee5 n\u1eb7ng v\u1ec1 CPU. \u0110i\u1ec1u n\xe0y c\xf3 th\u1ec3 g\xe2y \u1ea3nh h\u01b0\u1edfng t\u1edbi hi\u1ec7u su\u1ea5t c\u1ee7a Event Loop b\u1eb1ng c\xe1ch l\xe0m ch\u1eadm ho\u1eb7c ch\u1eb7n n\xf3. V\xec v\u1eady, worker_thread ra \u0111\u1eddi nh\u1eb1m kh\u1eafc ph\u1ee5c h\u1ea1n ch\u1ebf n\xe0y b\u1eb1ng c\xe1ch t\u1ea1o ra nh\u1eefng lu\u1ed3ng ri\xeang bi\u1ec7t, gi\xfap gi\u1ea3m t\u1ea3i cho Event Loop ch\xednh v\xe0 c\u1ea3i thi\u1ec7n hi\u1ec7u su\u1ea5t."),(0,i.kt)("p",null,"Khi \u0111\u01b0\u1ee3c t\u1ea1o ra, m\u1ed7i lu\u1ed3ng trong worker_thread s\u1ebd c\xf3 m\u1ed9t v\xf9ng nh\u1edb stack v\xe0 heap ri\xeang, gi\xfap tr\xe1nh c\xe1c l\u1ed7i li\xean quan \u0111\u1ebfn ",(0,i.kt)("inlineCode",{parentName:"p"},"stack overflow"),". Th\xf4ng qua vi\u1ec7c truy\u1ec1n tin nh\u1eafn (message passing), c\xe1c lu\u1ed3ng n\xe0y c\xf3 th\u1ec3 t\u01b0\u01a1ng t\xe1c v\u1edbi nhau m\xe0 kh\xf4ng g\u1eb7p nh\u1eefng v\u1ea5n \u0111\u1ec1 th\xf4ng th\u01b0\u1eddng c\u1ee7a \u0111a lu\u1ed3ng nh\u01b0 deadlocks hay race conditions. Tuy nhi\xean, qu\xe1 tr\xecnh chuy\u1ec3n \u0111\u1ed5i ng\u1eef c\u1ea3nh (",(0,i.kt)("inlineCode",{parentName:"p"},"context switching"),") gi\u1eefa c\xe1c lu\u1ed3ng c\u0169ng c\xf3 th\u1ec3 l\xe0m gi\u1ea3m hi\u1ec7u su\u1ea5t khi c\xf3 qu\xe1 nhi\u1ec1u lu\u1ed3ng \u0111\u01b0\u1ee3c t\u1ea1o ra."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/quankori/quankori.github.io/master/src/images/programming/worker-thread.jpg",alt:"Image"})),(0,i.kt)("p",null,"M\u1ed9t v\xed d\u1ee5 v\u1ec1 Worker Threads trong b\xe0i to\xe1n n\xe9n file"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"child-thread.js")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'const { parentPort } = require("worker_threads");\nconst JSZip = require("jszip");\nconst fs = require("fs");\nconst path = require("path");\n\nparentPort.on("message", async () => {\n  const imagesDirectory = path.join(__dirname, "images");\n  const zip = new JSZip();\n\n  fs.readdirSync(imagesDirectory).forEach((file) => {\n    const filePath = path.join(imagesDirectory, file);\n    const data = fs.readFileSync(filePath);\n    zip.file(file, data);\n  });\n\n  const zipData = await zip.generateAsync({ type: "nodebuffer" });\n  fs.writeFileSync(path.join(__dirname, "output.zip"), zipData);\n  parentPort.postMessage("File zip \u0111\xe3 \u0111\u01b0\u1ee3c t\u1ea1o: output.zip");\n});\n')),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"main-thread.js")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'const { Worker } = require("worker_threads");\n\n// T\u1ea1o Worker Thread th\u1ee9 nh\u1ea5t\nconst worker1 = new Worker("./src/worker-thread/child-thread.js");\nworker1.on("message", (message) =>\n  console.log("Tin nh\u1eafn t\u1eeb Worker 1:", message)\n);\nworker1.postMessage("D\u1eef li\u1ec7u cho Worker 1");\n\n// T\u1ea1o Worker Thread th\u1ee9 hai\nconst worker2 = new Worker("./src/worker-thread/child-thread.js");\nworker2.on("message", (message) =>\n  console.log("Tin nh\u1eafn t\u1eeb Worker 2:", message)\n);\nworker2.postMessage("D\u1eef li\u1ec7u cho Worker 2");\n')),(0,i.kt)("h2",{id:"child-process"},"Child Process"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/quankori/quankori.github.io/master/src/images/programming/child-process.jpg",alt:"Image"})),(0,i.kt)("h2",{id:"cluster-trong-nodejs"},"Cluster trong Node.js"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/quankori/quankori.github.io/master/src/images/programming/cluster.jpg",alt:"Image"})),(0,i.kt)("h2",{id:"t\xf3m-t\u1eaft"},"T\xf3m t\u1eaft"),(0,i.kt)("h2",{id:"ngu\u1ed3n"},"Ngu\u1ed3n"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"M\u1ed9t cu\u1ed1n s\xe1ch kh\xe1 hay n\xf3i v\u1ec1 vi\u1ec7c qu\u1ea3n l\xfd thread v\xe0 process l\xe0\n",(0,i.kt)("a",{parentName:"li",href:"https://zalopay-oss.github.io/go-advanced/ch1-basic/ch1-05-concurrency-parallelism.html"},"Go Advanced - ZaloPay"),", \u0111\xe2y l\xe0 cu\u1ed1n s\xe1ch v\u1ec1 Golang do team ZaloPay public, d\xf9 kh\xf4ng d\xednh v\u1ec1 Node.js nh\u01b0ng v\u1ec1 Process v\xe0 Thread th\xec r\u1ea5t \u0111\u1ea7y \u0111\u1ee7")))}u.isMDXComponent=!0}}]);