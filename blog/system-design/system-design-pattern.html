<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-blog/system-design/system-design-pattern">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">System Design Pattern | Quan Nguyen</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://quankori.github.io/blog/system-design/system-design-pattern"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="System Design Pattern | Quan Nguyen"><meta data-rh="true" name="description" content="SAGA Pattern: Quản lý Transaction Phân tán"><meta data-rh="true" property="og:description" content="SAGA Pattern: Quản lý Transaction Phân tán"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://quankori.github.io/blog/system-design/system-design-pattern"><link data-rh="true" rel="alternate" href="https://quankori.github.io/blog/system-design/system-design-pattern" hreflang="en"><link data-rh="true" rel="alternate" href="https://quankori.github.io/blog/system-design/system-design-pattern" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://a-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Quan Nguyen" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.d2c8af8d.css">
<link rel="preload" href="/assets/js/runtime~main.c2b93575.js" as="script">
<link rel="preload" href="/assets/js/main.8db436b3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/icon.png" alt="Kori Blog" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/icon.png" alt="Kori Blog" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Kori Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">My Note</a></div><div class="navbar__items navbar__items--right"><div class="navbar-search searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://www.linkedin.com/in/quankori/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">My Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/quankori/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-icon" title="My Github" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">About Me</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/blog/system-design/checklist">System Design</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/system-design/checklist">Checklist</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/system-design/monolithic">Monolithic Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/system-design/domain-centric">Domain Centric Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/system-design/event-driven">Event Driven Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/system-design/microservices">Microservices Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/system-design/serverless">Serverless Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/blog/system-design/system-design-pattern">System Design Pattern</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/system-design/database">Database</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/blog/programming/nodejs">Programming Language</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/blog/english/cheatsheet">English</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">System Design</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">System Design Pattern</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>System Design Pattern</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="saga-pattern-quản-lý-transaction-phân-tán">SAGA Pattern: Quản lý Transaction Phân tán<a href="#saga-pattern-quản-lý-transaction-phân-tán" class="hash-link" aria-label="Direct link to SAGA Pattern: Quản lý Transaction Phân tán" title="Direct link to SAGA Pattern: Quản lý Transaction Phân tán">​</a></h2><p>Trong kiến trúc microservices, một nghiệp vụ kinh doanh (business transaction) thường phải trải qua nhiều service khác nhau. Việc duy trì tính nhất quán dữ liệu (consistency) trở nên phức tạp vì chúng ta không thể sử dụng các transaction ACID truyền thống kéo dài qua nhiều database độc lập. SAGA pattern ra đời để giải quyết vấn đề này.</p><p>Một SAGA là một chuỗi các local transaction. Mỗi local transaction trong SAGA sẽ cập nhật dữ liệu trong một service cụ thể và phát ra một message hoặc event để kích hoạt local transaction tiếp theo trong service khác. Nếu một local transaction thất bại, SAGA sẽ thực thi các compensating transaction để hoàn tác (undo) các thay đổi đã được thực hiện bởi các local transaction trước đó, đảm bảo tính nhất quán cuối cùng (eventual consistency).</p><p>Có hai cách chính để điều phối SAGA:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="choreography-điều-phối-phi-tập-trung">Choreography (Điều phối Phi tập trung)<a href="#choreography-điều-phối-phi-tập-trung" class="hash-link" aria-label="Direct link to Choreography (Điều phối Phi tập trung)" title="Direct link to Choreography (Điều phối Phi tập trung)">​</a></h3><p>Mỗi service tự biết phải làm gì tiếp theo dựa trên các event nhận được từ các service khác. Không có một bộ điều phối trung tâm.</p><p>Service A hoàn thành local transaction, publish một event (ví dụ: OrderCreated). Service B lắng nghe event này, thực hiện local transaction của mình và publish event tiếp theo (ví dụ: PaymentProcessed). Service C lắng nghe event của B, v.v. Nếu Service B thất bại, nó sẽ publish một event lỗi (ví dụ: PaymentFailed), và Service A (hoặc một service khác) sẽ lắng nghe event này để thực thi compensating transaction (ví dụ: hủy đơn hàng).</p><p>Ưu điểm:</p><ul><li><p>Đơn giản, dễ hiểu cho các SAGA ngắn.</p></li><li><p>Không có điểm lỗi trung tâm (single point of failure) trong việc điều phối.</p></li><li><p>Các service ít phụ thuộc (loosely coupled).</p></li></ul><p>Nhược điểm:</p><ul><li><p>Khó theo dõi luồng nghiệp vụ khi SAGA có nhiều bước.</p></li><li><p>Dễ xảy ra phụ thuộc vòng (cyclic dependencies) giữa các service nếu không cẩn thận.</p></li><li><p>Việc debug và kiểm thử trở nên phức tạp.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="orchestration-điều-phối-tập-trung">Orchestration (Điều phối Tập trung)<a href="#orchestration-điều-phối-tập-trung" class="hash-link" aria-label="Direct link to Orchestration (Điều phối Tập trung)" title="Direct link to Orchestration (Điều phối Tập trung)">​</a></h3><p>Có một service điều phối trung tâm (Orchestrator) chịu trách nhiệm chỉ đạo luồng SAGA. Orchestrator gửi các command đến từng service để yêu cầu thực hiện local transaction và nhận lại kết quả (hoặc event).</p><p>Client gửi request tạo đơn hàng đến Orchestrator. Orchestrator gửi command CreateOrder đến Order Service. Order Service thực hiện xong, trả kết quả về Orchestrator. Orchestrator gửi command ProcessPayment đến Payment Service. Nếu Payment Service thành công, Orchestrator gửi command ShipOrder đến Shipping Service. Nếu Payment Service thất bại, Orchestrator sẽ gửi command CancelOrder (compensating transaction) đến Order Service.</p><p>Ưu điểm:</p><ul><li><p>Luồng nghiệp vụ được quản lý tập trung, dễ hiểu và theo dõi.</p></li><li><p>Dễ dàng quản lý các phụ thuộc và logic phức tạp.</p></li><li><p>Ít khả năng xảy ra phụ thuộc vòng.</p></li></ul><p>Nhược điểm:</p><ul><li><p>Orchestrator có thể trở thành điểm lỗi trung tâm.</p></li><li><p>Logic nghiệp vụ tập trung quá nhiều vào Orchestrator.</p></li><li><p>Các service tham gia SAGA phụ thuộc vào Orchestrator.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cqrs-command-query-responsibility-segregation">CQRS (Command Query Responsibility Segregation)<a href="#cqrs-command-query-responsibility-segregation" class="hash-link" aria-label="Direct link to CQRS (Command Query Responsibility Segregation)" title="Direct link to CQRS (Command Query Responsibility Segregation)">​</a></h2><p>Là một mẫu (pattern) tách biệt hoàn toàn trách nhiệm giữa việc thay đổi trạng thái hệ thống (thông qua các Commands) và việc truy vấn trạng thái hệ thống (thông qua các Queries)</p><p><strong>Commands</strong>: Đại diện cho ý định thay đổi trạng thái (ví dụ: CreateUserCommand, UpdateProductPriceCommand). Chúng thường không trả về dữ liệu mà chỉ báo thành công/thất bại. Logic xử lý command có thể phức tạp.</p><p><strong>Queries</strong>: Đại diện cho yêu cầu lấy dữ liệu (ví dụ: GetUserByIdQuery, GetProductsByCategoryQuery). Chúng chỉ đọc dữ liệu và không làm thay đổi trạng thái. Logic xử lý query thường đơn giản hơn.</p><p>Mô hình dữ liệu riêng biệt (Optional but common): Thường đi kèm với việc sử dụng các mô hình dữ liệu (data models) khác nhau cho việc ghi (write model - tối ưu cho việc ghi và đảm bảo tính nhất quán) và việc đọc (read model(s) - tối ưu cho việc truy vấn nhanh, có thể là các view được chuẩn bị sẵn, denormalized). Dữ liệu từ write model thường được cập nhật sang read model(s) một cách bất đồng bộ (ví dụ: thông qua events).</p><p>Lợi ích: Tối ưu hóa độc lập cho việc đọc và ghi, cải thiện hiệu năng, khả năng mở rộng (có thể scale riêng phần đọc và phần ghi), đơn giản hóa các mô hình dữ liệu phức tạp.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="backends-for-frontend-bff-tối-ưu-giao-diện-người-dùng">Backends for Frontend (BFF): Tối ưu Giao diện Người dùng<a href="#backends-for-frontend-bff-tối-ưu-giao-diện-người-dùng" class="hash-link" aria-label="Direct link to Backends for Frontend (BFF): Tối ưu Giao diện Người dùng" title="Direct link to Backends for Frontend (BFF): Tối ưu Giao diện Người dùng">​</a></h2><p>BFF là một pattern kiến trúc nơi bạn tạo ra các backend API riêng biệt, được tối ưu hóa cho từng loại giao diện người dùng (frontend client) cụ thể (ví dụ: web app, mobile app, desktop app). Thay vì một API gateway chung chung, mỗi client type sẽ có một BFF riêng.</p><p>Các loại client khác nhau thường có nhu cầu dữ liệu và định dạng khác nhau. Một API chung có thể trả về quá nhiều hoặc quá ít dữ liệu, hoặc định dạng không phù hợp, buộc client phải xử lý thêm logic. BFF giúp đơn giản hóa phía client.</p><p>BFF đóng vai trò như một lớp trung gian giữa client và các microservices hạ nguồn (downstream). Nó nhận request từ client, gọi đến một hoặc nhiều microservices cần thiết, tổng hợp, biến đổi dữ liệu và trả về kết quả theo đúng định dạng mà client đó mong muốn.</p><p>Ưu điểm:</p><ul><li><p>Tối ưu hóa trải nghiệm cho từng loại client.</p></li><li><p>Giảm logic xử lý ở phía client.</p></li><li><p>Cho phép các team frontend phát triển độc lập hơn với các backend service chung.</p></li><li><p>Cải thiện bảo mật bằng cách chỉ expose những gì cần thiết cho từng client.</p></li></ul><p>Nhược điểm:</p><ul><li><p>Tăng số lượng backend cần phát triển và quản lý.</p></li><li><p>Có thể dẫn đến trùng lặp code giữa các BFF nếu không quản lý tốt.</p></li><li><p>Tăng thêm một lớp mạng (network hop).</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transactional-outbox-và-inbox-pattern-đảm-bảo-tin-cậy-trong-giao-tiếp-bất-đồng-bộ">Transactional Outbox và Inbox Pattern: Đảm bảo Tin cậy trong Giao tiếp Bất đồng bộ<a href="#transactional-outbox-và-inbox-pattern-đảm-bảo-tin-cậy-trong-giao-tiếp-bất-đồng-bộ" class="hash-link" aria-label="Direct link to Transactional Outbox và Inbox Pattern: Đảm bảo Tin cậy trong Giao tiếp Bất đồng bộ" title="Direct link to Transactional Outbox và Inbox Pattern: Đảm bảo Tin cậy trong Giao tiếp Bất đồng bộ">​</a></h2><p>Khi một service cần cập nhật database của mình VÀ gửi một message/event đến một service khác (ví dụ: thông qua message queue như Kafka, RabbitMQ), làm thế nào để đảm bảo cả hai hành động này xảy ra một cách nguyên tử (atomic)? Nếu cập nhật DB thành công nhưng gửi message thất bại (hoặc ngược lại), hệ thống sẽ rơi vào trạng thái không nhất quán.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transactional-outbox">Transactional Outbox<a href="#transactional-outbox" class="hash-link" aria-label="Direct link to Transactional Outbox" title="Direct link to Transactional Outbox">​</a></h3><p>Thay vì trực tiếp gửi message sau khi cập nhật DB, service sẽ ghi message đó vào một bảng đặc biệt trong cùng database gọi là &quot;outbox table&quot;, trong cùng một local transaction với việc cập nhật dữ liệu nghiệp vụ.</p><p>Workflow:</p><ol><li><p>Bắt đầu một local database transaction.</p></li><li><p>Cập nhật bảng dữ liệu nghiệp vụ (ví dụ: Orders).</p></li><li><p>Chèn một record mô tả message/event vào bảng Outbox (chứa thông tin như đích đến, payload,...).</p></li><li><p>Commit database transaction.</p></li><li><p>Một tiến trình riêng biệt (message relay/event publisher) sẽ theo dõi bảng Outbox, đọc các message chưa gửi và publish chúng lên message broker. Sau khi publish thành công, message trong bảng Outbox sẽ được đánh dấu là đã gửi hoặc xóa đi.</p></li></ol><p>Vì cả việc cập nhật dữ liệu nghiệp vụ và ghi vào outbox đều nằm trong cùng một DB transaction, chúng sẽ hoặc cùng thành công hoặc cùng thất bại (atomicity). Tiến trình relay đảm bảo message cuối cùng sẽ được gửi đi (at-least-once delivery).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transactional-inbox">Transactional Inbox<a href="#transactional-inbox" class="hash-link" aria-label="Direct link to Transactional Inbox" title="Direct link to Transactional Inbox">​</a></h3><p>Là pattern phía service nhận message, đảm bảo việc xử lý message và cập nhật trạng thái là idempotent (thực hiện nhiều lần không thay đổi kết quả sau lần đầu thành công) và đáng tin cậy.</p><p>Workflow:</p><ol><li><p>Service nhận (consumer) đọc message từ message broker.</p></li><li><p>Ghi thông tin message (ví dụ: message ID) vào một bảng Inbox trong database của mình. Kiểm tra xem message ID này đã được xử lý chưa. Nếu đã xử lý, bỏ qua message (đảm bảo idempotency).</p></li><li><p>Nếu chưa xử lý:</p></li></ol><ul><li><p>Bắt đầu một local database transaction.</p></li><li><p>Xử lý message (ví dụ: cập nhật dữ liệu nghiệp vụ).</p></li><li><p>Đánh dấu message trong bảng Inbox là đã xử lý.</p></li><li><p>Commit database transaction.</p></li></ul><p>Ngăn chặn việc xử lý trùng lặp message trong trường hợp message được gửi lại (at-least-once delivery từ broker).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fan-outfan-in-pattern-xử-lý-song-song-và-tổng-hợp-kết-quả">Fan-out/Fan-in Pattern: Xử lý Song song và Tổng hợp Kết quả<a href="#fan-outfan-in-pattern-xử-lý-song-song-và-tổng-hợp-kết-quả" class="hash-link" aria-label="Direct link to Fan-out/Fan-in Pattern: Xử lý Song song và Tổng hợp Kết quả" title="Direct link to Fan-out/Fan-in Pattern: Xử lý Song song và Tổng hợp Kết quả">​</a></h2><p>Đây là một pattern luồng công việc (workflow pattern) thường được sử dụng để tăng tốc độ xử lý bằng cách chia một tác vụ lớn thành nhiều tác vụ nhỏ hơn chạy song song (Fan-out) và sau đó tổng hợp kết quả từ các tác vụ con đó (Fan-in).</p><p>Hoạt động:</p><p><strong>Fan-out</strong>: Một thành phần điều phối (dispatcher/orchestrator) nhận một yêu cầu hoặc một tập dữ liệu lớn. Nó chia nhỏ công việc hoặc dữ liệu thành nhiều phần và gửi từng phần đến các worker khác nhau để xử lý đồng thời/song song. Ví dụ: gửi các ID sản phẩm cần cập nhật giá đến nhiều instance của Price Update Service.</p><p><strong>Fan-in</strong>: Sau khi các worker hoàn thành xử lý phần việc của mình, chúng gửi kết quả trở lại. Một thành phần tổng hợp (aggregator/collector) sẽ đợi nhận đủ kết quả từ các worker (hoặc đến một ngưỡng nào đó/timeout) và tổng hợp chúng thành kết quả cuối cùng. Ví dụ: nhận các trạng thái cập nhật giá từ các worker và báo cáo kết quả tổng thể.</p><p>Ưu điểm:</p><ul><li><p>Tăng đáng kể tốc độ xử lý cho các tác vụ có thể chia nhỏ và song song hóa.</p></li><li><p>Cải thiện khả năng mở rộng bằng cách thêm nhiều worker hơn.</p></li></ul><p>Nhược điểm:</p><ul><li><p>Phức tạp trong việc quản lý luồng công việc, xử lý lỗi của từng worker, và tổng hợp kết quả.</p></li><li><p>Cần cơ chế để theo dõi trạng thái của các tác vụ con.</p></li><li><p>Chi phí giao tiếp mạng giữa dispatcher, worker, và aggregator.</p></li></ul><p>Khi nào sử dụng: Khi cần xử lý một lượng lớn dữ liệu hoặc thực hiện một tác vụ phức tạp có thể được chia thành các phần độc lập chạy song song để giảm thời gian hoàn thành tổng thể. Thường thấy trong xử lý batch, data processing pipelines, hoặc các hệ thống tính toán hiệu năng cao.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="shared-database-anti-pattern-cạm-bẫy-cần-tránh">Shared Database Anti-Pattern: Cạm bẫy Cần Tránh<a href="#shared-database-anti-pattern-cạm-bẫy-cần-tránh" class="hash-link" aria-label="Direct link to Shared Database Anti-Pattern: Cạm bẫy Cần Tránh" title="Direct link to Shared Database Anti-Pattern: Cạm bẫy Cần Tránh">​</a></h2><p>Đây là một anti-pattern (một giải pháp phổ biến nhưng không hiệu quả và nên tránh) trong kiến trúc microservices, nơi nhiều service khác nhau cùng truy cập và thao tác trên cùng một schema database.</p><p>Tại sao là Anti-pattern:</p><ul><li><p>Coupling (Phụ thuộc chặt chẽ): Bất kỳ thay đổi nào trong schema database (thêm/sửa/xóa bảng, cột) bởi một team có thể ảnh hưởng hoặc làm hỏng các service khác đang dùng chung database đó. Điều này đi ngược lại nguyên tắc độc lập và tự chủ của microservices.</p></li><li><p>Khó khăn trong việc phát triển và triển khai độc lập: Các team không thể tự do thay đổi cấu trúc dữ liệu của mình mà không cần phối hợp chặt chẽ và kiểm thử hồi quy (regression testing) trên tất cả các service liên quan.</p></li><li><p>Khó khăn trong việc scale: Việc scale database trở nên phức tạp vì phải đáp ứng nhu cầu của nhiều service khác nhau với các pattern truy cập dữ liệu khác nhau. Khó tối ưu hóa database cho một service cụ thể.</p></li><li><p>Rào cản công nghệ: Tất cả các service buộc phải sử dụng chung một công nghệ database, hạn chế khả năng lựa chọn công nghệ phù hợp nhất cho từng service.</p></li></ul><p>Giải pháp thay thế: Mỗi microservice nên sở hữu dữ liệu và database riêng của mình (Database per Service pattern). Việc giao tiếp và chia sẻ dữ liệu giữa các service nên được thực hiện thông qua các API được định nghĩa rõ ràng hoặc qua cơ chế event/messaging (kết hợp với các pattern như SAGA, Outbox/Inbox nếu cần đảm bảo consistency).</p><p>Khi nào cần đặc biệt lưu ý: Khi chuyển đổi từ kiến trúc monolith sang microservices, việc tách database là một trong những thách thức lớn nhất và cần được thực hiện cẩn thận để tránh rơi vào anti-pattern này.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/system-design/serverless"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Serverless Architecture</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/system-design/database"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Database</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#saga-pattern-quản-lý-transaction-phân-tán" class="table-of-contents__link toc-highlight">SAGA Pattern: Quản lý Transaction Phân tán</a><ul><li><a href="#choreography-điều-phối-phi-tập-trung" class="table-of-contents__link toc-highlight">Choreography (Điều phối Phi tập trung)</a></li><li><a href="#orchestration-điều-phối-tập-trung" class="table-of-contents__link toc-highlight">Orchestration (Điều phối Tập trung)</a></li></ul></li><li><a href="#cqrs-command-query-responsibility-segregation" class="table-of-contents__link toc-highlight">CQRS (Command Query Responsibility Segregation)</a></li><li><a href="#backends-for-frontend-bff-tối-ưu-giao-diện-người-dùng" class="table-of-contents__link toc-highlight">Backends for Frontend (BFF): Tối ưu Giao diện Người dùng</a></li><li><a href="#transactional-outbox-và-inbox-pattern-đảm-bảo-tin-cậy-trong-giao-tiếp-bất-đồng-bộ" class="table-of-contents__link toc-highlight">Transactional Outbox và Inbox Pattern: Đảm bảo Tin cậy trong Giao tiếp Bất đồng bộ</a><ul><li><a href="#transactional-outbox" class="table-of-contents__link toc-highlight">Transactional Outbox</a></li><li><a href="#transactional-inbox" class="table-of-contents__link toc-highlight">Transactional Inbox</a></li></ul></li><li><a href="#fan-outfan-in-pattern-xử-lý-song-song-và-tổng-hợp-kết-quả" class="table-of-contents__link toc-highlight">Fan-out/Fan-in Pattern: Xử lý Song song và Tổng hợp Kết quả</a></li><li><a href="#shared-database-anti-pattern-cạm-bẫy-cần-tránh" class="table-of-contents__link toc-highlight">Shared Database Anti-Pattern: Cạm bẫy Cần Tránh</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/"><img src="/img/icon.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="40" height="40"><img src="/img/icon.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="40" height="40"></a></div><div class="footer__copyright">Copyright © 2025 Quan Kori</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c2b93575.js"></script>
<script src="/assets/js/main.8db436b3.js"></script>
</body>
</html>